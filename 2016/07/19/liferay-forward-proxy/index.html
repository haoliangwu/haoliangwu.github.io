<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> liferay和proxy server那点事 · Fine, thank you, and you.</title><meta name="description" content="liferay和proxy server那点事 - Lyon Wu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><link rel="stylesheet" href="/css/apollo.css"><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.ico"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/pages/" target="_self" class="nav-list-link"><i class="fa fa-bookmark">&nbsp;</i>Pages</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link"><i class="fa fa-folder-open-o">&nbsp;</i>Archive</a></li><li class="nav-list-item"><a href="https://github.com/haoliangwu" target="_self" class="nav-list-link"><i class="fa fa-github-alt">&nbsp;</i>GitHub</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">liferay和proxy server那点事</h1><div class="post-info">Jul 19, 2016</div><div class="post-content"><blockquote>
<p>Set up a server to use as a proxy for requests from Liferay (such as Apache web server)</p>
</blockquote>
<a id="more"></a>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>Ubuntu 14.04</li>
<li>httpd(apache2 for Ubuntu)</li>
<li>liferay 7.0</li>
</ul>
<h1 id="知识背景"><a href="#知识背景" class="headerlink" title="知识背景"></a>知识背景</h1><p>这里的proxy server应当是指正向代理(forward proxy)。正向代理大概的意思，就是一个位于客户端和原始服务器之间的服务器，当客户端为了从原始服务器拿一些内容的时候，不向原始服务器直接发送请求而是向代理服务器发送，代理服务器转发客户端请求给原始服务器并将获得内容返还给客户端。</p>
<p>正向代理的意思，大体就是一个跳板，对于你不方便去的地方或者不能去的地方，它可以带你去，比如一些vpn代理，其原理就是你访问代理服务器，代理服务器访问被墙的网站，之后把内容返还给你。</p>
<p>既然说了正向代理，就捎带说一下反向代理。反向代理和正向代理相反，对与访问者来说，你访问一个反向代理服务器后，它同样会从原始服务器拿数据，但是这里和正向代理的区别是，访问者不需要进行额外的设置，反向代理服务器判断请求如何转发给原始服务器，之后把内容返还给客户端。</p>
<p>反向代理的意思，大体就是一个服务柜台，对于你不方便去的地方或者不能去的地方，有人可以帮你去，比如一些设置了防火墙的原始服务器为了提供给外网用户访问，就会使用反向代理。</p>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h3 id="配置proxy-server"><a href="#配置proxy-server" class="headerlink" title="配置proxy server"></a>配置proxy server</h3><p>以ubuntu为例(windows应该会更方便)，直接用apt-get安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install apache2</div></pre></td></tr></table></figure>
<p>之后server的根目录是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/apache2</div></pre></td></tr></table></figure></p>
<p>进入这里，会发现有一个<strong>apache2.conf</strong>的配置文件，这个文件是apache2的主要配置文件，其中包含了若干子配置文件，分别配置不同模块的配置，看注释就可以大概知道每个模块是做什么的。</p>
<p>我们这里需要着重看的是<strong>ports.conf</strong>和<strong>000-default.conf</strong>。</p>
<p>前者主要设置一些关于server监听端口的配置，它的源码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Listen 80</div><div class="line"></div><div class="line">&lt;IfModule ssl_module&gt;</div><div class="line">	Listen 443</div><div class="line">&lt;/IfModule&gt;</div><div class="line"></div><div class="line">&lt;IfModule mod_gnutls.c&gt;</div><div class="line">	Listen 443</div><div class="line">&lt;/IfModule&gt;</div></pre></td></tr></table></figure></p>
<p>大体的意思是</p>
<blockquote>
<p>监听80端口，如果有ssl_module和mod_gnutls.c模块加载的话，同时也监听443端口。</p>
</blockquote>
<p>如果你还想监听别端口，比如81，可以直接添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Listen 81</div></pre></td></tr></table></figure></p>
<p>后者主要设置一些关于虚拟主机的配置，<strong>apache2.conf</strong>中有一行代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">IncludeOptional sites-enabled/*.conf</div></pre></td></tr></table></figure></p>
<p>意思是会在启动服务器的时候，把所有<strong>./sites-enabled</strong>目录下的配置文件都包含进来，所以我们可以自己新建一个.conf文件，也可以直接更改默认的文件，也就是<strong>000-default.conf</strong>。</p>
<h2 id="配置VirtualHost"><a href="#配置VirtualHost" class="headerlink" title="配置VirtualHost"></a>配置VirtualHost</h2><p>配置完proxy server的监听端口，该配置虚拟主机了，打开默认配置文件，添加如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">ProxyRequests On</div><div class="line">ProxyVia On</div><div class="line"></div><div class="line">&lt;VirtualHost *:80&gt;  </div><div class="line">	ServerAdmin prograsliu@gmail.com</div><div class="line">    ServerName www.test.com</div><div class="line">    ServerAlias test.com</div><div class="line">    ErrorLog &quot;logs/test.com-error.log&quot;</div><div class="line">    CustomLog &quot;logs/test.com-access.log&quot; common    </div><div class="line">    </div><div class="line">    #正向代理设置</div><div class="line">    ProxyRequests On</div><div class="line">    ProxyVia On</div><div class="line"></div><div class="line">    &lt;Proxy *&gt;</div><div class="line">        Order deny,allow</div><div class="line">        Deny from all</div><div class="line">        Allow from 127.0.0.1</div><div class="line">    &lt;/Proxy&gt;</div><div class="line">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>
<p>开启Apache正向代理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ProxyRequests On</div></pre></td></tr></table></figure></p>
<p>之后设置控制位于代理服务器链中的代理请求的流向<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ProxyVia On</div></pre></td></tr></table></figure></p>
<p>每个请求和应答都会对应当前主机得到一个”Via:”头。</p>
<p>再设置对apache监听主机的请求的匹配规则<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;VirtualHost *:80&gt;</div></pre></td></tr></table></figure></p>
<p>这个表示匹配所有80端口的请求，之后又由于这个标签中还有一些其他的设置，如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ServerName www.test.com</div><div class="line">ServerAlias test.com</div><div class="line">ErrorLog &quot;logs/test.com-error.log&quot;</div><div class="line">CustomLog &quot;logs/test.com-access.log&quot; common</div></pre></td></tr></table></figure></p>
<p>因此，匹配规则会变为，匹配所有请求www.test.com:80这个主机的请求，同时呢，这个主机的小名是test.com，日志文件根据事件类型按不同路径保存。</p>
<h2 id="测试一下"><a href="#测试一下" class="headerlink" title="测试一下"></a>测试一下</h2><p>设置到这里，proxy server已经设置完成，因此也可以来简单测试一下，比如打开ＦＦ浏览器，之后在<strong>Preference &gt; Advanced &gt; Connection</strong>中，选择<strong>manual proxy configuration</strong>，然后把代理配置填进去，比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">HTTP proxy: www.test.com</div><div class="line">Port: 80</div></pre></td></tr></table></figure></p>
<p>注意下面有一个<strong>No Proxy for</strong>的选项，因此不要拿本地的请求作测试。</p>
<p>然后访问<strong>www.163.com</strong>，使用f12抓包，可以发现请求的相应头(response header)中，会增加一个字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Via: &quot;1.1 www.test.com&quot;</div></pre></td></tr></table></figure></p>
<p>大体意思就是，你打开的163的页面，并不是从网易的浏览器直接获得的，而是从你配置的叫做www.test.com的代理服务器获得的，真正访问网易服务器的是www.test.com。</p>
<h2 id="配置liferay"><a href="#配置liferay" class="headerlink" title="配置liferay"></a>配置liferay</h2><p>接下来就很简单了，只需要让liferay来使用我们配置好的proxy server即可。</p>
<p>liferay中的system.properties有如下三个参数，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># Set the location of the HTTP proxy that the portal will use to fetch</div><div class="line"># external content.</div><div class="line">#</div><div class="line"># Set http.nonProxyHosts for hosts that will not be proxied. This is useful</div><div class="line"># for proxied environments where you need direct access to internal servers.</div><div class="line"># This should follow the same semantics as the java.net package.</div><div class="line">#</div><div class="line">#http.proxyHost=192.168.0.200</div><div class="line">#http.proxyPort=4480</div><div class="line">#http.nonProxyHosts=192.168.0.250</div></pre></td></tr></table></figure></p>
<p>最后一个不用管，只需要配置前两个，把它改成我们配置的proxy server对应的参数即可，如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http.proxyHost=www.test.com</div><div class="line">http.proxyPort=80</div></pre></td></tr></table></figure></p>
<p>之后就大功告成了。当portal从外部的server，获取资源时，会使用代理，比如使用亚马逊的s3 store云储存服务时。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.cnblogs.com/zemliu/archive/2012/04/18/2454655.html" target="_blank" rel="external">Apache配置正向代理与反向代理</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/22/liferay-progress-bar/" class="prev">上一篇</a><a href="/2016/07/15/liferay-smile-face/" class="next">下一篇</a></div><div data-thread-key="2016/07/19/liferay-forward-proxy/" data-title="liferay和proxy server那点事" data-url="http://yoursite.com/2016/07/19/liferay-forward-proxy/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"littlelyno"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2018 <a href="https://github.com/haoliangwu">Lyon Wu</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async src="//littlelyon.com/js/index.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-83849508-1",'auto');ga('send','pageview');</script></body></html>